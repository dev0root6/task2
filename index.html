<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Task2 â€” The Mystery House (Harder)</title>
<style>
  :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;--accent:#0b76ff}
  body{background:#000000;color:#0c1723;padding:18px}
  .wrap{max-width:920px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.08)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:1.25rem}
  .timer{font-weight:700;color:var(--accent)}
  .status{margin-top:10px;padding:10px;background:#f7fbff;border-radius:8px;border:1px dashed #e6f0ff}
  .games{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .game{padding:12px;border-radius:8px;border:1px solid #eef3fb;background:#fcfeff}
  .game h3{margin:0 0 8px 0;font-size:1rem}
  .small{font-size:0.9rem;color:#536170}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .cell{background:#f1f5f9;border-radius:6px;padding:18px;text-align:center;cursor:pointer;user-select:none;border:1px solid #e6eefc}
  .cell.on{background:#f71616;color:#fff;border-color:#0b76ff;box-shadow:0 4px 10px rgba(11,118,255,0.18)}
  .controls{margin-top:12px}
  input[type="text"], input[type="number"]{padding:8px;border-radius:6px;border:1px solid #d6dde8;width:100%}
  button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .reveal{margin-top:18px;padding:12px;border-radius:8px;background:#0b76ff;color:#fff;display:none}
  .hintline{margin-top:10px;font-size:0.9rem;color:#334155}
  footer{margin-top:16px;font-size:0.85rem;color:#64748b}
  .done-list{display:flex;gap:10px;align-items:center}
  .badge{padding:6px 8px;border-radius:6px;background:#eef7ff;border:1px solid #d7eefc}
  .frag{font-family:monospace;font-size:0.9rem;color:#123;margin-left:8px}
  .tiny{font-size:0.78rem;color:#6b7280}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Task 2 â€” The Mystery House (Harder)</h1>
        <div class="small">Three logic rooms. Solve them, collect the fragments, assemble the key, and unlock the secret â€” all within 60 seconds.</div>
      </div>
      <div style="text-align:right">
        <div>Time left</div>
        <div class="timer" id="countdown">--:--</div>
        <div class="small">Round ID: <span id="roundId">â€”</span></div>
      </div>
    </header>

    <div class="status">
      <div class="done-list">Progress:
        <span class="badge" id="g1Badge">Grid</span>
        <span class="badge" id="g2Badge">Sequence</span>
        <span class="badge" id="g3Badge">Assembly</span>
        <span style="margin-left:auto" class="small">Completed <strong id="countDone">0</strong>/3</span>
      </div>
      <div class="hintline" id="roundMsg">New round started â€” think clearly and move quickly.</div>
    </div>

    <div class="games">
      <!-- Game 1: Lights-Out Grid (tougher) -->
      <div class="game" id="game1">
        <h3>Game 1 â€” The Logic Grid (Lights Out)</h3>
        <div class="small">Click a cell to toggle it and its orthogonal neighbors. Your goal is to make <strong>all</strong> cells ON. This is a classic logic puzzle â€” some configurations require strategy.</div>
        <div class="grid" id="logicGrid" aria-label="3x3 logic grid">
          <!-- generated by JS -->
        </div>
        <div class="controls">
          <button id="shuffleGrid">Shuffle start</button>
          <button id="resetG1">Clear</button>
          <span id="g1ok" class="complete" style="display:none">âœ“ Solved</span>
          <div class="tiny">When solved you will be given a fragment (ASCII numbers) to collect.</div>
          <div class="frag" id="frag1" style="display:none">Fragment: <span id="frag1txt"></span></div>
        </div>
      </div>

      <!-- Game 2: Harder Number Sequence -->
      <div class="game" id="game2">
        <h3>Game 2 â€” Sequence Insight</h3>
        <div class="small">Study the sequence and enter the next number. This one hides a deeper rule.</div>
        <pre style="background:#fbfdff;padding:8px;border-radius:6px;border:1px solid #eef6ff">2, 6, 12, 20, 30, ?</pre>
        <div class="small">(Hint: each term equals n*(n+1), for n starting at 1.)</div>
        <div style="margin-top:8px">
          <input id="seqAnswer" type="number" placeholder="Enter the next number" />
        </div>
        <div class="controls" style="margin-top:8px">
          <button id="submitSeq">Submit</button>
          <span id="g2ok" class="complete" style="display:none">âœ“ Solved</span>
          <div class="tiny">Solving reveals another numeric fragment â€” keep track.</div>
          <div class="frag" id="frag2" style="display:none">Fragment: <span id="frag2txt"></span></div>
        </div>
      </div>

      <!-- Game 3: Assembly / Trigger -->
      <div class="game" id="game3" style="grid-column:span 2">
        <h3>Game 3 â€” The Assembly Chamber</h3>
        <div class="small">This chamber requires you to combine numeric fragments revealed by the other puzzles. When converted from ASCII, the concatenation will form the secret key.</div>
        <p class="small">Find the fragments on the page (they appear after solving G1 and G2). Decode decimal ASCII numbers to characters, concatenate (in order), and enter the resulting secret key below, then click the emblem to submit.</p>

        <div style="margin-top:10px;display:flex;gap:12px;align-items:center">
          <div id="emblem" style="width:48px;height:48px;border-radius:8px;border:1px solid #e2eefb;display:flex;align-items:center;justify-content:center;cursor:pointer" title="Click me to submit">âš‘</div>
          <div class="small">Emblem â€” click after entering the assembled key.</div>
        </div>

        <div class="controls" style="margin-top:8px">
          <input id="assemblyInput" type="text" placeholder="Enter assembled secret key (case-sensitive)" />
          <button id="tryAssembly">Submit</button>
            <span id="g3ok" class="complete" style="display:none">âœ“ Solved</span>
        </div>

        <div class="hintline" style="margin-top:10px">Tip: convert decimal ASCII codes (e.g., 97 â†’ 'a') and join them. The comment in the page gives the instruction about ordering. Also press CTRL+U </div>
      </div>
    </div>

    <!-- Reveal area -->
    <div id="revealArea" class="reveal" role="status" aria-live="polite">
      <div style="font-weight:700">ðŸŽ‰ All puzzles solved â€” secret revealed!</div>
      <div style="margin-top:8px">Hidden file link: <a id="secretLink" href="https://dev0root6.github.io/task2/secret/hidden.txt" target="_blank" rel="noopener noreferrer">https://dev0root6.github.io/task2/secret/hidden.txt</a></div>
      <div style="margin-top:8px">Next hint (base64): <code id="nextHint">V0VDUjRDS0VEMVQ=</code></div>
      <div style="margin-top:6px" class="small">(Base64 decodes to the final flag for Task 3.)</div>
    </div>

    <footer>
      <div class="small">Round resets every 60 seconds. The assembly instruction is in a comment â€” read the source carefully to learn how to order fragments.</div>
    </footer>
  </div>

  <!--
    ASSEMBLY INSTRUCTION (hidden comment) â€” view source to read:
    When you solve Grid: you receive fragment1 (decimal ASCII group).
    When you solve Sequence: you receive fragment2 (decimal ASCII group).
    ORDER: fragment1 then fragment2. Convert each decimal to characters and concatenate.
    Example: fragment1 = "117 110" (-> 'u' 'n'), fragment2 = "108 111 99 107 52 50" (-> 'l' 'o' 'c' 'k' '4' '2')
    Combined -> "unlock42" (this would be the assembled secret)
    NOTE: The fragments you get on page are the actual ones to use â€” don't rely on example above.
  -->

<script>
/* Harder Mystery House â€” Task 2 logic
   - 3 games
   - 60s window (resets progress)
   - solving G1 & G2 reveals ASCII decimal fragments
   - player must convert decimals -> chars, concatenate in order, and submit via Game3
*/

const ROUND_KEY_PREFIX = 'mystery_round_';
let roundStart = null;
let roundExpires = null;
let roundKey = null;
const ROUND_LEN = 60_000; // 60 seconds

function startRound() {
  roundStart = Date.now();
  roundKey = ROUND_KEY_PREFIX + roundStart;
  roundExpires = roundStart + ROUND_LEN;
  sessionStorage.setItem('mystery_active_round', String(roundStart));
  // initialize progress for this round and clear fragments
  sessionStorage.setItem(roundKey, JSON.stringify({g1:false,g2:false,g3:false, frag1:null, frag2:null}));
  document.getElementById('roundId').textContent = String(roundStart).slice(-6);
  document.getElementById('roundMsg').textContent = 'Round started â€” collect fragments and assemble the key.';
  updateUI();
  scheduleReset();
}

function scheduleReset() {
  clearInterval(window._countdownInterval);
  window._countdownInterval = setInterval(updateCountdown, 250);
  clearTimeout(window._resetTimeout);
  const ms = roundExpires - Date.now();
  window._resetTimeout = setTimeout(() => {
    resetRound();
    startRound();
  }, ms > 0 ? ms : 0);
}

function updateCountdown() {
  const left = Math.max(0, roundExpires - Date.now());
  const s = Math.ceil(left/1000);
  const mm = String(Math.floor(s/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  document.getElementById('countdown').textContent = `${mm}:${ss}`;
  if (left <= 0) {
    document.getElementById('roundMsg').textContent = 'Time expired â€” new round starting...';
  }
}

/* ---- progress helpers ---- */
function getProgress() {
  const raw = sessionStorage.getItem(roundKey);
  if (!raw) return {g1:false,g2:false,g3:false, frag1:null, frag2:null};
  try { return JSON.parse(raw); } catch(e){return {g1:false,g2:false,g3:false, frag1:null, frag2:null};}
}
function setProgress(p) {
  sessionStorage.setItem(roundKey, JSON.stringify(p));
  updateUI();
}
function markDone(game){
  const p = getProgress();
  if (p[game]) return;
  p[game] = true;
  setProgress(p);
  updateUI();
  checkReveal();
}
function countDone(){
  const p = getProgress();
  return [p.g1,p.g2,p.g3].filter(Boolean).length;
}

function updateUI(){
  const p = getProgress();
  document.getElementById('g1Badge').style.opacity = p.g1 ? 1 : 0.5;
  document.getElementById('g2Badge').style.opacity = p.g2 ? 1 : 0.5;
  document.getElementById('g3Badge').style.opacity = p.g3 ? 1 : 0.5;
  document.getElementById('countDone').textContent = countDone();
  document.getElementById('g1ok').style.display = p.g1 ? 'inline-block':'none';
  document.getElementById('g2ok').style.display = p.g2 ? 'inline-block':'none';
  document.getElementById('g3ok').style.display = p.g3 ? 'inline-block':'none';
  // show fragments if available
  if (p.frag1) {
    document.getElementById('frag1txt').textContent = p.frag1;
    document.getElementById('frag1').style.display = 'block';
  } else { document.getElementById('frag1').style.display = 'none'; }
  if (p.frag2) {
    document.getElementById('frag2txt').textContent = p.frag2;
    document.getElementById('frag2').style.display = 'block';
  } else { document.getElementById('frag2').style.display = 'none'; }

  document.getElementById('revealArea').style.display = (p.g1 && p.g2 && p.g3) ? 'block':'none';
}

/* ---- Reset ---- */
function resetRound(){
  sessionStorage.removeItem(roundKey);
  document.getElementById('roundMsg').textContent = 'Round reset. A new round will start now.';
  // rebuild grid
  createLogicGrid();
  document.getElementById('seqAnswer').value = '';
  document.getElementById('assemblyInput').value = '';
  document.getElementById('revealArea').style.display = 'none';
  updateUI();
}

/* ---------- Game 1: Lights-Out (3x3) ---------- */
/* We'll generate a random but solvable starting config by applying a few random presses to an all-off board.
   Toggling logic flips cell and orthogonal neighbors. Goal: all ON.
   On solve, reveal fragment1: a decimal ASCII group (e.g., "117 110").
*/

function makeEmptyBoard(){ return Array(9).fill(0); }

function idx(r,c){ return r*3 + c; }

function toggleAt(board, r, c){
  const coords = [[r,c],[r-1,c],[r+1,c],[r,c-1],[r,c+1]];
  coords.forEach(([rr,cc])=>{
    if (rr>=0 && rr<3 && cc>=0 && cc<3) {
      const i = idx(rr,cc);
      board[i] = board[i] ? 0 : 1;
    }
  });
}

function createLogicGrid(){
  const grid = document.getElementById('logicGrid');
  grid.innerHTML = '';
  const board = makeEmptyBoard();
  // apply 6 random presses to create a solvable start (since pressing is reversible)
  for (let k=0;k<6;k++){
    const r = Math.floor(Math.random()*3);
    const c = Math.floor(Math.random()*3);
    toggleAt(board,r,c);
  }
  // store board in dataset to allow reset/inspect
  grid.dataset.board = JSON.stringify(board);

  board.forEach((val,i)=>{
    const div = document.createElement('div');
    div.className = 'cell' + (val ? ' on' : '');
    div.dataset.idx = i;
    div.textContent = val ? 'ON' : 'OFF';
    div.tabIndex = 0;
    div.addEventListener('click', ()=> handleCellClick(div));
    div.addEventListener('keypress', (e)=>{ if(e.key==='Enter') handleCellClick(div); });
    grid.appendChild(div);
  });
}

function handleCellClick(div){
  const grid = document.getElementById('logicGrid');
  let board = JSON.parse(grid.dataset.board);
  const i = Number(div.dataset.idx);
  const r = Math.floor(i/3), c = i%3;
  toggleAt(board,r,c);
  grid.dataset.board = JSON.stringify(board);
  // redraw
  Array.from(grid.children).forEach((child, idxChild)=> {
    const v = board[idxChild];
    child.classList.toggle('on', !!v);
    child.textContent = v ? 'ON' : 'OFF';
  });
  // check if all on
  const allOn = board.every(v=>v===1);
  if (allOn){
    // mark done and reveal fragment1 if not already revealed
    const p = getProgress();
    if (!p.g1) {
      // fragment1: decimal ASCII group (you can change these numbers)
      const frag = "117 110"; // 'u' 'n' -> example piece
      p.frag1 = frag;
      setProgress(p);
      document.getElementById('frag1txt').textContent = frag;
      document.getElementById('frag1').style.display = 'block';
    }
    markDone('g1');
    document.getElementById('roundMsg').textContent = 'Grid solved â€” fragment revealed.';
  }
}

document.getElementById('shuffleGrid').addEventListener('click', ()=>{
  createLogicGrid();
  const p = getProgress(); p.g1 = false; p.frag1 = null; setProgress(p);
});
document.getElementById('resetG1').addEventListener('click', ()=>{
  // clear to all off
  const grid = document.getElementById('logicGrid');
  const board = makeEmptyBoard();
  grid.dataset.board = JSON.stringify(board);
  Array.from(grid.children).forEach((child, idxChild)=> {
    child.classList.remove('on');
    child.textContent = 'OFF';
  });
  const p = getProgress(); p.g1 = false; p.frag1 = null; setProgress(p);
});

/* ---------- Game 2: Sequence (harder) ---------- */
/* Sequence: 2,6,12,20,30 -> next 42 (n*(n+1))
   When solved, reveal fragment2 (decimal ASCII group)
*/
document.getElementById('submitSeq').addEventListener('click', ()=>{
  const val = Number(document.getElementById('seqAnswer').value);
  if (val === 42) {
    const p = getProgress();
    if (!p.g2) {
      // fragment2 decimals (e.g., '108 111 99 107 52 50' -> 'lock42')
      // choose fragment so combined with frag1 yields 'unlock42' example
      const frag2 = "108 111 99 107 52 50"; // 'l' 'o' 'c' 'k' '4' '2'
      p.frag2 = frag2;
      setProgress(p);
      document.getElementById('frag2txt').textContent = frag2;
      document.getElementById('frag2').style.display = 'block';
    }
    markDone('g2');
    document.getElementById('roundMsg').textContent = 'Sequence solved â€” fragment revealed.';
  } else {
    document.getElementById('roundMsg').textContent = 'Incorrect â€” consider the formula for each term.';
  }
});

/* ---------- Game 3: Assembly / Submit ---------- */
/* The assembly step requires taking frag1 then frag2, converting each decimal to characters,
   concatenating, and entering the resulting key.
   Example with the fragments above:
     frag1 = "117 110" -> 'u' 'n'
     frag2 = "108 111 99 107 52 50" -> 'l' 'o' 'c' 'k' '4' '2'
     assembled -> "unlock42"
*/
const emblem = document.getElementById('emblem');
document.getElementById('tryAssembly').addEventListener('click', attemptAssembly);
emblem.addEventListener('click', attemptAssembly);

function decsToString(decs){
  return decs.split(/\s+/).map(n=>String.fromCharCode(Number(n))).join('');
}

function attemptAssembly(){
  const p = getProgress();
  if (!p.frag1 || !p.frag2){
    document.getElementById('roundMsg').textContent = 'Missing fragments â€” solve earlier rooms to collect them.';
    return;
  }
  const assembledActual = decsToString(p.frag1) + decsToString(p.frag2);
  const supplied = (document.getElementById('assemblyInput').value || '').trim();
  if (supplied === assembledActual){
    markDone('g3');
    document.getElementById('roundMsg').textContent = 'Assembly correct â€” emblem activated.';
  } else {
    // if they click emblem without typing, prompt (non-blocking)
    if (!supplied) {
      const inp = prompt('Enter assembled key (from fragments):','');
      if (inp && inp.trim() === assembledActual){
        markDone('g3');
        document.getElementById('roundMsg').textContent = 'Assembly correct â€” emblem activated.';
        return;
      } else {
        document.getElementById('roundMsg').textContent = 'Key incorrect. Convert decimal ASCII fragments and concatenate.';
      }
    } else {
      document.getElementById('roundMsg').textContent = 'Key incorrect. Convert decimals and join characters. Order: frag1 then frag2.';
    }
  }
}

/* ---------- Check reveal ---------- */
function checkReveal(){
  const p = getProgress();
  if (p.g1 && p.g2 && p.g3){
    document.getElementById('revealArea').style.display = 'block';
    document.getElementById('roundMsg').textContent = 'All puzzles solved â€” secret revealed!';
  }
}

/* ---------- Startup ---------- */
(function init(){
  const active = sessionStorage.getItem('mystery_active_round');
  if (active && Number(active) + ROUND_LEN > Date.now()){
    roundStart = Number(active);
    roundKey = ROUND_KEY_PREFIX + roundStart;
    roundExpires = roundStart + ROUND_LEN;
    document.getElementById('roundId').textContent = String(roundStart).slice(-6);
    updateUI();
    scheduleReset();
  } else {
    startRound();
  }
  // build initial UI
  createLogicGrid();
})();
</script>
</body>
</html>
